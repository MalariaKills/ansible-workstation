---
# Minimal playbook for Mac - LazyVim config only
# Usage: ansible-playbook -i localhost-inventory.ini minimal-playbook-mac.yml

- name: Setup LazyVim Config on Mac
  hosts: localhost
  connection: local
  become: no
  
  tasks:
    - name: Install git via Homebrew
      homebrew:
        name: git
        state: present
    
    - name: Install neovim via Homebrew
      homebrew:
        name: neovim
        state: present
    
    - name: Install Ghostty terminal via Homebrew
      homebrew_cask:
        name: ghostty
        state: present
    
    - name: Install Node.js via Homebrew (required for Claude Code)
      shell: brew install node
      args:
        creates: /opt/homebrew/bin/node
      register: node_install
      failed_when: 
        - node_install.rc != 0
        - "'already installed' not in node_install.stderr"
    
    - name: Install Claude Code via npm
      npm:
        name: "@anthropic-ai/claude-code"
        global: yes
        state: present
    
    - name: Create .config directory
      file:
        path: "{{ ansible_env.HOME }}/.config"
        state: directory
        mode: '0755'
    
    - name: Backup existing nvim config if it exists
      command: mv {{ ansible_env.HOME }}/.config/nvim {{ ansible_env.HOME }}/.config/nvim.bak.{{ ansible_date_time.epoch }}
      args:
        removes: "{{ ansible_env.HOME }}/.config/nvim"
      ignore_errors: yes
    
    - name: Clone unix_dotfiles repository
      git:
        repo: git@github.com:MalariaKills/unix_dotfiles.git
        dest: "{{ ansible_env.HOME }}/unix_dotfiles"
        version: main
        accept_hostkey: yes
    
    - name: Create symlink from unix_dotfiles/nvim to ~/.config/nvim
      file:
        src: "{{ ansible_env.HOME }}/unix_dotfiles/nvim"
        dest: "{{ ansible_env.HOME }}/.config/nvim"
        state: link
        force: yes
    
    - name: Display completion message
      debug:
        msg: "Setup complete! Nvim config symlinked from ~/unix_dotfiles/nvim. Run 'nvim' to let LazyVim install plugins."
